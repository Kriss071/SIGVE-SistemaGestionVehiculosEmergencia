{% extends "backoffice/base.html" %}

{% block backoffice_title %}Gestión de Roles{% endblock %}
{% block backoffice_page_title %}Roles de Usuario{% endblock %}

{% block backoffice_actions %}
<div class="btn-group me-2">
    <a href="#" class="btn btn-sm btn-outline-success">
        <i class="bi bi-plus-circle-fill me-1"></i> Nuevo Rol
    </a>
</div>
{% endblock %}

{% block backoffice_content %}
<div class="table-responsive">
    <table class="table table-striped table-hover table-sm align-middle">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Nombre</th>
                <th scope="col">Descripción</th>
                <th scope="col">Fecha Creación</th>
                <th scope="col" class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for role in roles %}
            <tr>
                <td>{{ role.id }}</td>
                <td>{{ role.name }}</td>
                <td>{{ role.description }}</td>
                <td>{{ role.created_at }}</td>
                <td class="text-end">
                    <a href="#" class="btn btn-sm btn-outline-primary me-1" title="Editar">
                        <i class="bi bi-pencil-fill"></i>
                    </a>
                    {# Botón para abrir modal de confirmación #}
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteRoleModal" data-role-id="{{ role.id }}" data-role-name="{{ role.name }}" title="Eliminar">
                        <i class="bi bi-trash3-fill"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">No hay roles registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# --- Modal de Confirmación de Eliminación --- #}
<div class="modal fade" id="deleteRoleModal" tabindex="-1" aria-labelledby="deleteRoleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteRoleModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar el rol "<strong id="modalRoleName"></strong>"?
        <br><small class="text-danger">Esta acción no se puede deshacer y podría afectar a los usuarios asignados a este rol.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        {# Formulario para enviar la solicitud DELETE (vía POST) #}
        <form id="deleteRoleForm" method="POST" action="">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Eliminar Rol</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block backoffice_scripts %}
<script>
    // Script para manejar el modal de eliminación
    const deleteRoleModal = document.getElementById('deleteRoleModal');
    if (deleteRoleModal) {
        deleteRoleModal.addEventListener('show.bs.modal', event => {
            // Botón que activó el modal
            const button = event.relatedTarget;
            // Extraer info de los atributos data-*
            const roleId = button.getAttribute('data-role-id');
            const roleName = button.getAttribute('data-role-name');

            // Actualizar contenido del modal
            const modalTitle = deleteRoleModal.querySelector('.modal-title');
            const modalBodyStrong = deleteRoleModal.querySelector('#modalRoleName');
            const deleteForm = deleteRoleModal.querySelector('#deleteRoleForm');

            modalBodyStrong.textContent = roleName;
            // Construir la URL de acción para el formulario
            // Asume que la URL es como /backoffice/roles/ID/delete/
            deleteForm.action = `/backoffice/roles/${roleId}/delete/`;
        });
    }
</script>
{% endblock %}
