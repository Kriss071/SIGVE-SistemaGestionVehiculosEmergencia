{% extends "backoffice/base.html" %}
{% load static %}

{% block backoffice_title %}Gestión de Empleados{% endblock %}
{% block backoffice_page_title %}Gestión de Empleados{% endblock %}

{% block backoffice_actions %}
  <!-- Botón para disparar el modal de creación -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
    <i class="bi bi-plus-circle me-2"></i> Agregar Empleado
  </button>
{% endblock %}

{% block backoffice_content %}
<div class="table-responsive">
  <table class="table table-striped table-hover table-sm align-middle">
    <thead>
      <tr>
        <th scope="col">Nombre</th>
        <th scope="col">RUT</th>
        <th scope="col">Rol</th>
        <th scope="col">Taller</th>
        <th scope="col">Activo</th>
        <th scope="col">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for emp in employees %}
      <!-- Guardamos los datos en atributos 'data-*' para fácil acceso con JS -->
      <tr data-id="{{ emp.id }}" data-full-name="{{ emp.first_name }} {{ emp.last_name }}" data-rut="{{ emp.rut|default:'' }}">
        <td>{{ emp.first_name }} {{ emp.last_name }}</td>
        <td>{{ emp.rut|default:"N/A" }}</td>
        <td>{{ emp.role_name|default:"N/A" }}</td>
        <td>{{ emp.workshop_name|default:"N/A" }}</td>
        <td>
          {% if emp.is_active %}
            <span class="badge bg-success">Sí</span>
          {% else %}
            <span class="badge bg-secondary">No</span>
          {% endif %}
        </td>
        <td>
          <!-- Botones para disparar los modales de edición y eliminación -->
          <button 
            type="button" 
            class="btn btn-sm btn-warning btn-edit-employee" 
            title="Editar"
            data-bs-toggle="modal" 
            data-bs-target="#updateEmployeeModal">
            <i class="bi bi-pencil-fill"></i>
          </button>
          <button 
            type="button" 
            class="btn btn-sm btn-danger btn-delete-employee" 
            title="Eliminar"
            data-bs-toggle="modal" 
            data-bs-target="#deleteEmployeeModal">
            <i class="bi bi-trash-fill"></i>
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center">No hay empleados registrados.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 
================================================================================
MODALES INTEGRADOS
================================================================================
Se han movido los 'include' aquí para que los modales estén en un solo archivo.
-->

<!-- Modal: Crear Empleado -->
<div class="modal fade" id="createEmployeeModal" tabindex="-1" aria-labelledby="createEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createEmployeeModalLabel">Crear Nuevo Empleado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <form id="createEmployeeForm" action="{% url 'backoffice:employee_create' %}" method="POST">
          {% csrf_token %}
          <div class="row g-3">

            <div class="col-md-6">
              <label for="{{ create_form.email.id_for_label }}" class="form-label">{{ create_form.email.label }}</label>
              {{ create_form.email }}
              {% if create_form.email.errors %}
                <div class="invalid-feedback d-block">{{ create_form.email.errors.as_text }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ create_form.password.id_for_label }}" class="form-label">{{ create_form.password.label }}</label>
              {{ create_form.password }}
              {% if create_form.password.errors %}
                <div class="invalid-feedback d-block">{{ create_form.password.errors.as_text }}</div>
              {% endif %}
            </div>
            <div class="col-12"><hr></div>
            
            <div class="col-md-6">
              <label for="{{ create_form.first_name.id_for_label }}" class="form-label">{{ create_form.first_name.label }}</label>
              {{ create_form.first_name }}
              {% if create_form.first_name.errors %}
                <div class="invalid-feedback d-block">
                  {{ create_form.first_name.errors.as_text }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ create_form.last_name.id_for_label }}" class="form-label">{{ create_form.last_name.label }}</label>
              {{ create_form.last_name }}
              {% if create_form.last_name.errors %}
                <div class="invalid-feedback d-block">
                  {{ create_form.last_name.errors.as_text }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ create_form.rut.id_for_label }}" class="form-label">{{ create_form.rut.label }}</label>
              {{ create_form.rut }}
              <div class="form-text">Ej: 12345678-9 (opcional)</div>
              {% if create_form.rut.errors %}
                <div class="invalid-feedback d-block">
                  {{ create_form.rut.errors.as_text }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ create_form.phone.id_for_label }}" class="form-label">{{ create_form.phone.label }}</label>
              {{ create_form.phone }}
              {% if create_form.phone.errors %}
                <div class="invalid-feedback d-block">
                  {{ create_form.phone.errors.as_text }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ create_form.role_id.id_for_label }}" class="form-label">{{ create_form.role_id.label }}</label>
              {{ create_form.role_id }}
              {% if create_form.role_id.errors %}
                <div class="invalid-feedback d-block">
                  {{ create_form.role_id.errors.as_text }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ create_form.workshop_id.id_for_label }}" class="form-label">{{ create_form.workshop_id.label }}</label>
              {{ create_form.workshop_id }}
              {% if create_form.workshop_id.errors %}
                <div class="invalid-feedback d-block">
                  {{ create_form.workshop_id.errors.as_text }}
                </div>
              {% endif %}
            </div>
            <div class="col-12">
              <div class="form-check">
                {{ create_form.is_active }}
                <label class="form-check-label" for="{{ create_form.is_active.id_for_label }}">
                  {{ create_form.is_active.label }}
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" form="createEmployeeForm" class="btn btn-primary">Crear Empleado</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Editar Empleado -->
<div class="modal fade" id="updateEmployeeModal" tabindex="-1" aria-labelledby="updateEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateEmployeeModalLabel">Editar Empleado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="updateEmployeeLoader" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <b class="ms-3">Cargando datos del empleado...</b>
        </div>
        <!-- El 'action' de este formulario será establecido por JavaScript -->
        <form id="updateEmployeeForm" action="" method="POST">
          
          {% csrf_token %}
          {{ update_form.id }}
          <div class="row g-3">
             <div class="col-md-6">
              <label for="{{ update_form.first_name.id_for_label }}" class="form-label">{{ update_form.first_name.label }}</label>
              {{ update_form.first_name }}
            </div>
            <div class="col-md-6">
              <label for="{{ update_form.last_name.id_for_label }}" class="form-label">{{ update_form.last_name.label }}</label>
              {{ update_form.last_name }}
            </div>
            <div class="col-md-6">
              <label for="{{ update_form.rut.id_for_label }}" class="form-label">{{ update_form.rut.label }}</label>
              {{ update_form.rut }}
              <div class="form-text">Ej: 12345678-9 (opcional)</div>
            </div>
            <div class="col-md-6">
              <label for="{{ update_form.phone.id_for_label }}" class="form-label">{{ update_form.phone.label }}</label>
              {{ update_form.phone }}
            </div>
            <div class="col-md-6">
              <label for="{{ update_form.role_id.id_for_label }}" class="form-label">{{ update_form.role_id.label }}</label>
              {{ update_form.role_id }}
            </div>
            <div class="col-md-6">
              <label for="{{ update_form.workshop_id.id_for_label }}" class="form-label">{{ update_form.workshop_id.label }}</label>
              {{ update_form.workshop_id }}
            </div>
            <div class="col-12">
              <div class="form-check">
                {{ update_form.is_active }}
                <label class="form-check-label" for="{{ update_form.is_active.id_for_label }}">
                  {{ update_form.is_active.label }}
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" form="updateEmployeeForm" class="btn btn-primary">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Eliminar Empleado -->
<div class="modal fade" id="deleteEmployeeModal" tabindex="-1" aria-labelledby="deleteEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteEmployeeModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar al empleado <strong id="deleteEmployeeName"></strong> (RUT: <span id="deleteEmployeeRUT"></span>)?</p>
        <p class="text-muted small">Esta acción no se puede deshacer.</p>
        
        <!-- El 'action' de este formulario será establecido por JavaScript -->
        <form id="deleteEmployeeForm" action="" method="POST">
          {% csrf_token %}
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="deleteEmployeeForm" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ block.super }} {# Incluye scripts de base.html #}
  <!-- Script específico para esta página -->
  <script src="{% static 'js/backoffice.js' %}"></script>
{% endblock %}

