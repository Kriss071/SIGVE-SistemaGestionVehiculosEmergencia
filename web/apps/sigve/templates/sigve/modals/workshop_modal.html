<style>
/* Estilos para campos readonly en el modal de taller */
#workshopModal .form-control[readonly],
#workshopModal .form-control:read-only {
    background-color: #e9ecef !important;
    opacity: 1 !important;
    cursor: not-allowed !important;
    color: #6c757d !important;
}

#workshopModal .form-control[readonly]:focus,
#workshopModal .form-control:read-only:focus {
    background-color: #e9ecef !important;
    border-color: #ced4da !important;
    box-shadow: none !important;
}
</style>

<!-- Modal para Crear/Editar/Ver Taller -->
<div class="modal fade" id="workshopModal" tabindex="-1" aria-labelledby="workshopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="workshopModalLabel">
                    <i class="bi bi-wrench"></i> <span id="workshopModalTitle">Crear Taller</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            
            <!-- Loading Spinner -->
            <div id="workshopModalLoading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando información del taller...</p>
            </div>
            
            <form method="post" action="{% url 'sigve:workshop_create' %}" id="workshopForm" style="display: none;">
                {% csrf_token %}
                <input type="hidden" name="workshop_id" id="workshopId">
                <input type="hidden" name="source" id="workshopSource" value="list">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_name" class="form-label">Nombre del Taller <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               name="name" 
                               id="id_name" 
                               placeholder="Ej: Mecánica Rápida"
                               required>
                        <small class="text-muted">Nombre oficial del taller</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_address" class="form-label">Dirección <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               name="address" 
                               id="id_address" 
                               placeholder="Ej: Av. Principal 123"
                               required>
                        <small class="text-muted">Dirección física del taller</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_phone" class="form-label">Teléfono</label>
                            <input type="text" 
                                   class="form-control" 
                                   name="phone" 
                                   id="id_phone" 
                                   placeholder="Ej: +56912345678">
                            <small class="text-muted">Teléfono de contacto</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_email" class="form-label">Email</label>
                            <input type="email" 
                                   class="form-control" 
                                   name="email" 
                                   id="id_email" 
                                   placeholder="Ej: contacto@taller.cl">
                            <small class="text-muted">Email de contacto</small>
                        </div>
                    </div>

                    <div class="alert alert-primary alert-permanent border-0" role="alert">
                        <small><i class="bi bi-info-circle me-1"></i>Los campos marcados con <span class="text-danger">*</span> son obligatorios</small>
                    </div>
                </div>
                <div class="modal-footer" id="workshopModalFooter">
                    <!-- Los botones se insertarán dinámicamente según el modo -->
                </div>
            </form>
        </div>
    </div>
</div>

<script>
/**
 * Sistema de gestión del modal de taller
 * Maneja tres modos: crear, ver, editar
 */
window.WorkshopModal = (function() {
    'use strict';
    
    // Referencias a elementos del DOM
    const modal = document.getElementById('workshopModal');
    const form = document.getElementById('workshopForm');
    const loading = document.getElementById('workshopModalLoading');
    const footer = document.getElementById('workshopModalFooter');
    const titleSpan = document.getElementById('workshopModalTitle');
    
    // Estado actual
    let currentMode = 'create'; // 'create', 'view', 'edit'
    let currentWorkshopId = null;
    let modalInstance = null;
    
    /**
     * Inicializa el modal
     */
    function init() {
        if (!modal || !form) return;
        
        modalInstance = new bootstrap.Modal(modal);
        
        // Evento al cerrar el modal
        modal.addEventListener('hidden.bs.modal', resetModal);
        
        // Evento al enviar el formulario
        form.addEventListener('submit', handleSubmit);
    }
    
    /**
     * Abre el modal en el modo especificado
     * @param {string} mode - 'create', 'view', 'edit'
     * @param {number} workshopId - ID del taller (para view/edit)
     * @param {string} source - 'dashboard' o 'list' (para saber desde dónde se abre)
     */
    function open(mode = 'create', workshopId = null, source = 'list') {
        currentMode = mode;
        currentWorkshopId = workshopId;
        
        // Guardar la fuente en el formulario para usarla al enviar
        const sourceInput = document.getElementById('workshopSource');
        if (sourceInput) {
            sourceInput.value = source;
        }
        
        if (mode === 'create') {
            setupCreateMode();
        } else if (mode === 'view' || mode === 'edit') {
            showLoading();
            modalInstance.show();
            loadWorkshopData(workshopId, mode);
        }
    }
    
    /**
     * Configura el modal para crear un taller
     */
    function setupCreateMode() {
        titleSpan.textContent = 'Crear Taller';
        form.action = '{% url "sigve:workshop_create" %}';
        form.reset();
        document.getElementById('workshopId').value = '';
        setFieldsEnabled(true);
        renderButtons('create');
        hideLoading();
        showForm();
        modalInstance.show();
    }
    
    /**
     * Carga los datos del taller
     */
    function loadWorkshopData(workshopId, mode) {
        fetch(`/sigve/api/workshops/${workshopId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateForm(data.workshop);
                    hideLoading();
                    showForm();
                    
                    // Aplicar el modo después de mostrar el formulario
                    if (mode === 'view') {
                        setupViewMode();
                    } else if (mode === 'edit') {
                        setupEditMode();
                    }
                } else {
                    throw new Error(data.error || 'Error al cargar el taller');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                SIGVENotifications.error('Error al cargar los datos del taller');
                modalInstance.hide();
            });
    }
    
    /**
     * Configura el modal para ver un taller (solo lectura)
     */
    function setupViewMode() {
        titleSpan.textContent = 'Ver Taller';
        renderButtons('view');
        // Usar setTimeout para asegurar que el DOM esté listo
        setTimeout(() => setFieldsEnabled(false), 0);
    }
    
    /**
     * Configura el modal para editar un taller
     */
    function setupEditMode() {
        titleSpan.textContent = 'Editar Taller';
        form.action = `/sigve/workshops/${currentWorkshopId}/edit/`;
        renderButtons('edit');
        // Usar setTimeout para asegurar que el DOM esté listo
        setTimeout(() => setFieldsEnabled(true), 0);
    }
    
    /**
     * Cambia del modo vista al modo edición
     */
    function switchToEditMode() {
        currentMode = 'edit';
        setupEditMode();
    }
    
    /**
     * Cancela la edición y vuelve al modo vista
     */
    function cancelEdit() {
        if (currentWorkshopId) {
            showLoading();
            form.style.display = 'none';
            loadWorkshopData(currentWorkshopId, 'view');
        }
    }
    
    /**
     * Llena el formulario con los datos del taller
     */
    function populateForm(workshop) {
        document.getElementById('workshopId').value = workshop.id || '';
        document.getElementById('id_name').value = workshop.name || '';
        document.getElementById('id_address').value = workshop.address || '';
        document.getElementById('id_phone').value = workshop.phone || '';
        document.getElementById('id_email').value = workshop.email || '';
    }
    
    /**
     * Habilita o deshabilita los campos del formulario
     */
    function setFieldsEnabled(enabled) {
        const fields = form.querySelectorAll('input, textarea, select');
        fields.forEach(field => {
            if (field.type !== 'hidden') {
                if (enabled) {
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                } else {
                    field.setAttribute('readonly', 'readonly');
                }
            }
        });
    }
    
    /**
     * Renderiza los botones del footer según el modo
     */
    function renderButtons(mode) {
        footer.innerHTML = '';
        
        if (mode === 'view') {
            footer.innerHTML = `
                <button type="button" class="btn btn-danger" onclick="WorkshopModal.confirmDelete()">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
                <button type="button" class="btn btn-primary" onclick="WorkshopModal.switchToEditMode()">
                    <i class="bi bi-pencil"></i> Editar
                </button>
            `;
        } else if (mode === 'edit') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="WorkshopModal.cancelEdit()">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-success" id="workshopSubmitBtn">
                    <i class="bi bi-check-lg"></i> Guardar Cambios
                </button>
            `;
        } else if (mode === 'create') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-primary" id="workshopSubmitBtn">
                    <i class="bi bi-check-lg"></i> Guardar Taller
                </button>
            `;
        }
    }
    
    /**
     * Maneja el envío del formulario
     */
    function handleSubmit(e) {
            e.preventDefault();
            
        const submitBtn = document.getElementById('workshopSubmitBtn');
        if (!submitBtn) return;
        
        // Deshabilitar botón
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
        // Enviar formulario
        const formData = new FormData(form);
            
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.redirected) {
                // Django redirige después de éxito
                // Seguir la redirección (para cuando viene de la lista)
                window.location.href = response.url;
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                if (data.success) {
                    // Éxito sin redirección (dashboard)
                    SIGVENotifications.success(data.message || 'Taller guardado correctamente');
                    modalInstance.hide();
                    
                    // Recargar la página para actualizar estadísticas
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else if (data.errors) {
                    // Errores de validación
                    SIGVENotifications.showValidationErrors(data.errors);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = currentMode === 'create' 
                        ? '<i class="bi bi-check-lg"></i> Guardar Taller'
                        : '<i class="bi bi-check-lg"></i> Guardar Cambios';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            SIGVENotifications.error('Error al guardar el taller');
            submitBtn.disabled = false;
            submitBtn.innerHTML = currentMode === 'create'
                ? '<i class="bi bi-check-lg"></i> Guardar Taller'
                : '<i class="bi bi-check-lg"></i> Guardar Cambios';
        });
    }
    
    /**
     * Confirma la eliminación del taller
     */
    function confirmDelete() {
        if (!currentWorkshopId) return;
        
        if (confirm('¿Estás seguro de eliminar este taller? Esta acción no se puede deshacer.')) {
            const deleteForm = document.createElement('form');
            deleteForm.method = 'POST';
            deleteForm.action = `/sigve/workshops/${currentWorkshopId}/delete/`;
            deleteForm.innerHTML = '<input type="hidden" name="csrfmiddlewaretoken" value="' + 
                                   document.querySelector('[name=csrfmiddlewaretoken]').value + '">';
            document.body.appendChild(deleteForm);
            deleteForm.submit();
        }
    }
    
    /**
     * Muestra el spinner de carga
     */
    function showLoading() {
        loading.style.display = 'block';
        form.style.display = 'none';
    }
    
    /**
     * Oculta el spinner y muestra el formulario
     */
    function hideLoading() {
        loading.style.display = 'none';
    }
    
    /**
     * Muestra el formulario
     */
    function showForm() {
        form.style.display = 'block';
    }
    
    /**
     * Resetea el modal a su estado inicial
     */
    function resetModal() {
        currentMode = 'create';
        currentWorkshopId = null;
        form.reset();
        setFieldsEnabled(true);
        footer.innerHTML = '';
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // API pública
    return {
        open,
        switchToEditMode,
        cancelEdit,
        confirmDelete
    };
})();
</script>

