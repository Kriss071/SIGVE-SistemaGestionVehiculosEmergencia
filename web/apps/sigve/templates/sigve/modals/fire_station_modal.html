<style>
/* Estilos para campos readonly en el modal de cuartel */
#fireStationModal .form-control[readonly],
#fireStationModal .form-control:read-only,
#fireStationModal .form-select[readonly],
#fireStationModal .form-select:read-only {
    background-color: #e9ecef !important;
    opacity: 1 !important;
    cursor: not-allowed !important;
    color: #6c757d !important;
}

#fireStationModal .form-control[readonly]:focus,
#fireStationModal .form-control:read-only:focus,
#fireStationModal .form-select[readonly]:focus,
#fireStationModal .form-select:read-only:focus {
    background-color: #e9ecef !important;
    border-color: #ced4da !important;
    box-shadow: none !important;
}
</style>

<!-- Modal para Crear/Editar/Ver Cuartel -->
<div class="modal fade" id="fireStationModal" tabindex="-1" aria-labelledby="fireStationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="fireStationModalLabel">
                    <i class="bi bi-fire"></i> <span id="fireStationModalTitle">Crear Cuartel</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            
            <!-- Loading Spinner -->
            <div id="fireStationModalLoading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando información del cuartel...</p>
            </div>
            
            <form method="post" action="{% url 'sigve:fire_station_create' %}" id="fireStationForm" style="display: none;">
                {% csrf_token %}
                <input type="hidden" name="fire_station_id" id="fireStationId">
                <input type="hidden" name="source" id="fireStationSource" value="list">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_fs_name" class="form-label">Nombre del Cuartel <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               name="name" 
                               id="id_fs_name" 
                               placeholder="Ej: Primera Compañía"
                               required>
                        <small class="text-muted">Nombre oficial del cuartel de bomberos</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_fs_address" class="form-label">Dirección <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               name="address" 
                               id="id_fs_address" 
                               placeholder="Ej: Calle Bomberos 456"
                               required>
                        <small class="text-muted">Dirección física del cuartel</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_fs_commune_id" class="form-label">Comuna <span class="text-danger">*</span></label>
                        <select class="form-select" name="commune_id" id="id_fs_commune_id" required>
                            <option value="">Cargando comunas...</option>
                        </select>
                        <small class="text-muted">Comuna donde se ubica el cuartel</small>
                    </div>
                    
                    <div class="alert alert-danger alert-permanent border-0" role="alert">
                        <small><i class="bi bi-info-circle me-1"></i>Los campos marcados con <span class="text-danger">*</span> son obligatorios</small>
                    </div>
                </div>
                <div class="modal-footer" id="fireStationModalFooter">
                    <!-- Los botones se insertarán dinámicamente según el modo -->
                </div>
            </form>
        </div>
    </div>
</div>

<script>
/**
 * Sistema de gestión del modal de cuartel
 * Maneja tres modos: crear, ver, editar
 */
window.FireStationModal = (function() {
    'use strict';
    
    // Referencias a elementos del DOM
    const modal = document.getElementById('fireStationModal');
    const form = document.getElementById('fireStationForm');
    const loading = document.getElementById('fireStationModalLoading');
    const footer = document.getElementById('fireStationModalFooter');
    const titleSpan = document.getElementById('fireStationModalTitle');
    const communeSelect = document.getElementById('id_fs_commune_id');
    
    // Estado actual
    let currentMode = 'create'; // 'create', 'view', 'edit'
    let currentFireStationId = null;
    let modalInstance = null;
    let communesLoaded = false;
    
    /**
     * Inicializa el modal
     */
    function init() {
        if (!modal || !form) return;
        
        modalInstance = new bootstrap.Modal(modal);
        
        // Evento al cerrar el modal
        modal.addEventListener('hidden.bs.modal', resetModal);
        
        // Evento al enviar el formulario
        form.addEventListener('submit', handleSubmit);
    }
    
    /**
     * Abre el modal en el modo especificado
     */
    function open(mode = 'create', fireStationId = null, source = 'list') {
        currentMode = mode;
        currentFireStationId = fireStationId;
        
        // Guardar la fuente en el formulario
        const sourceInput = document.getElementById('fireStationSource');
        if (sourceInput) {
            sourceInput.value = source;
        }
        
        if (mode === 'create') {
            setupCreateMode();
        } else if (mode === 'view' || mode === 'edit') {
            showLoading();
            modalInstance.show();
            loadFireStationData(fireStationId, mode);
        }
    }
    
    /**
     * Configura el modal para crear un cuartel
     */
    function setupCreateMode() {
        titleSpan.textContent = 'Crear Cuartel';
        form.action = '{% url "sigve:fire_station_create" %}';
        form.reset();
        document.getElementById('fireStationId').value = '';
        setFieldsEnabled(true);
        renderButtons('create');
        loadCommunes();
        hideLoading();
        showForm();
        modalInstance.show();
    }
    
    /**
     * Carga las comunas
     */
    function loadCommunes() {
        if (communesLoaded) return;
        
        fetch('/sigve/api/communes/')
            .then(response => response.json())
            .then(data => {
                communeSelect.innerHTML = '<option value="">Seleccionar comuna...</option>';
                if (data.communes) {
                    data.communes.forEach(commune => {
                        const option = document.createElement('option');
                        option.value = commune.id;
                        option.textContent = `${commune.name} - ${commune.province_name}, ${commune.region_name}`;
                        communeSelect.appendChild(option);
                    });
                    communesLoaded = true;
                }
            })
            .catch(error => {
                console.error('Error cargando comunas:', error);
                communeSelect.innerHTML = '<option value="">Error al cargar comunas</option>';
            });
    }
    
    /**
     * Carga los datos del cuartel
     */
    function loadFireStationData(fireStationId, mode) {
        // Asegurar que las comunas estén cargadas primero
        loadCommunes();
        
        fetch(`/sigve/api/fire-stations/${fireStationId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Esperar un poco a que las comunas se carguen
                    setTimeout(() => {
                        populateForm(data.fire_station);
                        hideLoading();
                        showForm();
                        
                        // Aplicar el modo después de mostrar el formulario
                        if (mode === 'view') {
                            setupViewMode();
                        } else if (mode === 'edit') {
                            setupEditMode();
                        }
                    }, 300);
                } else {
                    throw new Error(data.error || 'Error al cargar el cuartel');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                SIGVENotifications.error('Error al cargar los datos del cuartel');
                modalInstance.hide();
            });
    }
    
    /**
     * Configura el modal para ver un cuartel (solo lectura)
     */
    function setupViewMode() {
        titleSpan.textContent = 'Ver Cuartel';
        renderButtons('view');
        setTimeout(() => setFieldsEnabled(false), 0);
    }
    
    /**
     * Configura el modal para editar un cuartel
     */
    function setupEditMode() {
        titleSpan.textContent = 'Editar Cuartel';
        form.action = `/sigve/fire-stations/${currentFireStationId}/edit/`;
        renderButtons('edit');
        setTimeout(() => setFieldsEnabled(true), 0);
    }
    
    /**
     * Cambia del modo vista al modo edición
     */
    function switchToEditMode() {
        currentMode = 'edit';
        setupEditMode();
    }
    
    /**
     * Cancela la edición y vuelve al modo vista
     */
    function cancelEdit() {
        if (currentFireStationId) {
            showLoading();
            form.style.display = 'none';
            loadFireStationData(currentFireStationId, 'view');
        }
    }
    
    /**
     * Llena el formulario con los datos del cuartel
     */
    function populateForm(fireStation) {
        document.getElementById('fireStationId').value = fireStation.id || '';
        document.getElementById('id_fs_name').value = fireStation.name || '';
        document.getElementById('id_fs_address').value = fireStation.address || '';
        document.getElementById('id_fs_commune_id').value = fireStation.commune_id || '';
    }
    
    /**
     * Habilita o deshabilita los campos del formulario
     */
    function setFieldsEnabled(enabled) {
        const fields = form.querySelectorAll('input, textarea, select');
        fields.forEach(field => {
            if (field.type !== 'hidden') {
                if (enabled) {
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                } else {
                    field.setAttribute('readonly', 'readonly');
                }
            }
        });
    }
    
    /**
     * Renderiza los botones del footer según el modo
     */
    function renderButtons(mode) {
        footer.innerHTML = '';
        
        if (mode === 'view') {
            footer.innerHTML = `
                <button type="button" class="btn btn-danger" onclick="FireStationModal.confirmDelete()">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
                <button type="button" class="btn btn-primary" onclick="FireStationModal.switchToEditMode()">
                    <i class="bi bi-pencil"></i> Editar
                </button>
            `;
        } else if (mode === 'edit') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="FireStationModal.cancelEdit()">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-success" id="fireStationSubmitBtn">
                    <i class="bi bi-check-lg"></i> Guardar Cambios
                </button>
            `;
        } else if (mode === 'create') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-danger" id="fireStationSubmitBtn">
                    <i class="bi bi-check-lg"></i> Guardar Cuartel
                </button>
            `;
        }
    }
    
    /**
     * Maneja el envío del formulario
     */
    function handleSubmit(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('fireStationSubmitBtn');
        if (!submitBtn) return;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                if (data.success) {
                    SIGVENotifications.success(data.message || 'Cuartel guardado correctamente');
                    modalInstance.hide();
                    setTimeout(() => window.location.reload(), 1500);
                } else if (data.errors) {
                    SIGVENotifications.showValidationErrors(data.errors);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = currentMode === 'create' 
                        ? '<i class="bi bi-check-lg"></i> Guardar Cuartel'
                        : '<i class="bi bi-check-lg"></i> Guardar Cambios';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            SIGVENotifications.error('Error al guardar el cuartel');
            submitBtn.disabled = false;
            submitBtn.innerHTML = currentMode === 'create'
                ? '<i class="bi bi-check-lg"></i> Guardar Cuartel'
                : '<i class="bi bi-check-lg"></i> Guardar Cambios';
        });
    }
    
    /**
     * Confirma la eliminación del cuartel
     */
    function confirmDelete() {
        if (!currentFireStationId) return;
        
        if (confirm('¿Estás seguro de eliminar este cuartel? Esta acción no se puede deshacer.')) {
            const deleteForm = document.createElement('form');
            deleteForm.method = 'POST';
            deleteForm.action = `/sigve/fire-stations/${currentFireStationId}/delete/`;
            deleteForm.innerHTML = '<input type="hidden" name="csrfmiddlewaretoken" value="' + 
                                   document.querySelector('[name=csrfmiddlewaretoken]').value + '">';
            document.body.appendChild(deleteForm);
            deleteForm.submit();
        }
    }
    
    /**
     * Muestra el spinner de carga
     */
    function showLoading() {
        loading.style.display = 'block';
        form.style.display = 'none';
    }
    
    /**
     * Oculta el spinner y muestra el formulario
     */
    function hideLoading() {
        loading.style.display = 'none';
    }
    
    /**
     * Muestra el formulario
     */
    function showForm() {
        form.style.display = 'block';
    }
    
    /**
     * Resetea el modal a su estado inicial
     */
    function resetModal() {
        currentMode = 'create';
        currentFireStationId = null;
        form.reset();
        setFieldsEnabled(true);
        footer.innerHTML = '';
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // API pública
    return {
        open,
        switchToEditMode,
        cancelEdit,
        confirmDelete
    };
})();
</script>
