<!-- Modal para Crear/Editar Repuesto -->
<div class="modal fade" id="sparePartModal" tabindex="-1" aria-labelledby="sparePartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="sparePartModalLabel">
                    <i class="bi bi-gear"></i> <span id="sparePartModalTitle">Crear Repuesto</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="post" action="{% url 'sigve:spare_part_create' %}" id="sparePartForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="id_sp_name" class="form-label">Nombre del Repuesto <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   name="name" 
                                   id="id_sp_name" 
                                   placeholder="Ej: Filtro de Aceite"
                                   required>
                            <small class="text-muted">Nombre descriptivo del repuesto</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_sp_sku" class="form-label">SKU <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   name="sku" 
                                   id="id_sp_sku" 
                                   placeholder="Ej: FO-001"
                                   required>
                            <small class="text-muted">Código único SIGVE</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_sp_brand" class="form-label">Marca</label>
                        <input type="text" 
                               class="form-control" 
                               name="brand" 
                               id="id_sp_brand" 
                               placeholder="Ej: Mann Filter">
                        <small class="text-muted">Marca del repuesto (opcional)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_sp_description" class="form-label">Descripción</label>
                        <textarea class="form-control" 
                                  name="description" 
                                  id="id_sp_description" 
                                  rows="3" 
                                  placeholder="Descripción detallada del repuesto..."></textarea>
                        <small class="text-muted">Información adicional sobre el repuesto (opcional)</small>
                    </div>
                    
                    <div class="alert alert-success alert-permanent" role="alert">
                        <i class="bi bi-info-circle"></i> 
                        <small>Los campos marcados con <span class="text-danger">*</span> son obligatorios. El SKU debe ser único en el sistema.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success" id="sparePartSubmitBtn">
                        <i class="bi bi-check-lg"></i> Guardar Repuesto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Script para manejar el formulario del modal de repuesto
(function() {
    const sparePartForm = document.getElementById('sparePartForm');
    const sparePartModal = document.getElementById('sparePartModal');
    const submitBtn = document.getElementById('sparePartSubmitBtn');
    
    if (sparePartForm) {
        sparePartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Deshabilitar el botón y mostrar estado de carga
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
            // Obtener los datos del formulario
            const formData = new FormData(sparePartForm);
            
            // Enviar el formulario mediante fetch
            fetch(sparePartForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // Si hay redirección, es que fue exitoso
                    window.location.href = response.url;
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    if (data.success) {
                        // Mostrar toast de éxito
                        SIGVENotifications.success(data.message || 'Repuesto creado correctamente');
                        
                        // Cerrar el modal
                        const modalInstance = bootstrap.Modal.getInstance(sparePartModal);
                        modalInstance.hide();
                        
                        // Recargar después de mostrar el toast
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else if (data.errors) {
                        // Mostrar errores como toasts
                        SIGVENotifications.showValidationErrors(data.errors);
                        
                        // Restaurar botón
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Guardar Repuesto';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                SIGVENotifications.error('Ocurrió un error al guardar el repuesto. Por favor, intenta nuevamente.');
                
                // Restaurar botón
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Guardar Repuesto';
            });
        });
    }
    
    // Limpiar el formulario cuando se cierra el modal
    if (sparePartModal) {
        sparePartModal.addEventListener('hidden.bs.modal', function() {
            sparePartForm.reset();
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Guardar Repuesto';
        });
    }
})();
</script>

