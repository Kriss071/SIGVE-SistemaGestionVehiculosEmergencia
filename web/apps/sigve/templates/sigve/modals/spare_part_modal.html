<style>
/* Estilos para campos readonly en el modal de repuesto */
#sparePartModal .form-control[readonly],
#sparePartModal .form-control:read-only {
    background-color: #e9ecef !important;
    opacity: 1 !important;
    cursor: not-allowed !important;
    color: #6c757d !important;
}

#sparePartModal .form-control[readonly]:focus,
#sparePartModal .form-control:read-only:focus {
    background-color: #e9ecef !important;
    border-color: #ced4da !important;
    box-shadow: none !important;
}
</style>

<!-- Modal para Crear/Editar/Ver Repuesto -->
<div class="modal fade" id="sparePartModal" tabindex="-1" aria-labelledby="sparePartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="sparePartModalLabel">
                    <i class="bi bi-gear"></i> <span id="sparePartModalTitle">Crear Repuesto</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            
            <!-- Loading Spinner -->
            <div id="sparePartModalLoading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando información del repuesto...</p>
            </div>
            
            <form method="post" action="{% url 'sigve:spare_part_create' %}" id="sparePartForm" style="display: none;">
                {% csrf_token %}
                <input type="hidden" name="spare_part_id" id="sparePartId">
                <input type="hidden" name="source" id="sparePartSource" value="list">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="id_sp_name" class="form-label">Nombre del Repuesto <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   name="name" 
                                   id="id_sp_name" 
                                   placeholder="Ej: Filtro de Aceite"
                                   required>
                            <small class="text-muted">Nombre descriptivo del repuesto</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_sp_sku" class="form-label">SKU <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   name="sku" 
                                   id="id_sp_sku" 
                                   placeholder="Ej: FO-001"
                                   required>
                            <small class="text-muted">Código único SIGVE</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_sp_brand" class="form-label">Marca</label>
                        <input type="text" 
                               class="form-control" 
                               name="brand" 
                               id="id_sp_brand" 
                               placeholder="Ej: Mann Filter">
                        <small class="text-muted">Marca del repuesto (opcional)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_sp_description" class="form-label">Descripción</label>
                        <textarea class="form-control" 
                                  name="description" 
                                  id="id_sp_description" 
                                  rows="3" 
                                  placeholder="Descripción detallada del repuesto..."></textarea>
                        <small class="text-muted">Información adicional sobre el repuesto (opcional)</small>
                    </div>
                    
                    <div class="alert alert-success alert-permanent" role="alert">
                        <i class="bi bi-info-circle"></i> 
                        <small>Los campos marcados con <span class="text-danger">*</span> son obligatorios. El SKU debe ser único en el sistema.</small>
                    </div>
                </div>
                <div class="modal-footer" id="sparePartModalFooter">
                    <!-- Los botones se insertarán dinámicamente según el modo -->
                </div>
            </form>
        </div>
    </div>
</div>

<script>
/**
 * Sistema de gestión del modal de repuesto
 * Maneja tres modos: crear, ver, editar
 */
window.SparePartModal = (function() {
    'use strict';
    
    // Referencias a elementos del DOM
    const modal = document.getElementById('sparePartModal');
    const form = document.getElementById('sparePartForm');
    const loading = document.getElementById('sparePartModalLoading');
    const footer = document.getElementById('sparePartModalFooter');
    const titleSpan = document.getElementById('sparePartModalTitle');
    
    // Estado actual
    let currentMode = 'create';
    let currentSparePartId = null;
    let modalInstance = null;
    
    /**
     * Inicializa el modal
     */
    function init() {
        if (!modal || !form) return;
        
        modalInstance = new bootstrap.Modal(modal);
        
        modal.addEventListener('hidden.bs.modal', resetModal);
        form.addEventListener('submit', handleSubmit);
    }
    
    /**
     * Abre el modal en el modo especificado
     */
    function open(mode = 'create', sparePartId = null, source = 'list') {
        currentMode = mode;
        currentSparePartId = sparePartId;
        
        const sourceInput = document.getElementById('sparePartSource');
        if (sourceInput) {
            sourceInput.value = source;
        }
        
        if (mode === 'create') {
            setupCreateMode();
        } else if (mode === 'view' || mode === 'edit') {
            showLoading();
            modalInstance.show();
            loadSparePartData(sparePartId, mode);
        }
    }
    
    /**
     * Configura el modal para crear un repuesto
     */
    function setupCreateMode() {
        titleSpan.textContent = 'Crear Repuesto';
        form.action = '{% url "sigve:spare_part_create" %}';
        form.reset();
        document.getElementById('sparePartId').value = '';
        setFieldsEnabled(true);
        renderButtons('create');
        hideLoading();
        showForm();
        modalInstance.show();
    }
    
    /**
     * Carga los datos del repuesto
     */
    function loadSparePartData(sparePartId, mode) {
        fetch(`/sigve/api/spare-parts/${sparePartId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateForm(data.spare_part);
                    hideLoading();
                    showForm();
                    
                    if (mode === 'view') {
                        setupViewMode();
                    } else if (mode === 'edit') {
                        setupEditMode();
                    }
                } else {
                    throw new Error(data.error || 'Error al cargar el repuesto');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                SIGVENotifications.error('Error al cargar los datos del repuesto');
                modalInstance.hide();
            });
    }
    
    /**
     * Configura el modal para ver un repuesto (solo lectura)
     */
    function setupViewMode() {
        titleSpan.textContent = 'Ver Repuesto';
        renderButtons('view');
        setTimeout(() => setFieldsEnabled(false), 0);
    }
    
    /**
     * Configura el modal para editar un repuesto
     */
    function setupEditMode() {
        titleSpan.textContent = 'Editar Repuesto';
        form.action = `/sigve/spare-parts/${currentSparePartId}/edit/`;
        renderButtons('edit');
        setTimeout(() => setFieldsEnabled(true), 0);
    }
    
    /**
     * Cambia del modo vista al modo edición
     */
    function switchToEditMode() {
        currentMode = 'edit';
        setupEditMode();
    }
    
    /**
     * Cancela la edición y vuelve al modo vista
     */
    function cancelEdit() {
        if (currentSparePartId) {
            showLoading();
            form.style.display = 'none';
            loadSparePartData(currentSparePartId, 'view');
        }
    }
    
    /**
     * Llena el formulario con los datos del repuesto
     */
    function populateForm(sparePart) {
        document.getElementById('sparePartId').value = sparePart.id || '';
        document.getElementById('id_sp_name').value = sparePart.name || '';
        document.getElementById('id_sp_sku').value = sparePart.sku || '';
        document.getElementById('id_sp_brand').value = sparePart.brand || '';
        document.getElementById('id_sp_description').value = sparePart.description || '';
    }
    
    /**
     * Habilita o deshabilita los campos del formulario
     */
    function setFieldsEnabled(enabled) {
        const fields = form.querySelectorAll('input, textarea, select');
        fields.forEach(field => {
            if (field.type !== 'hidden') {
                if (enabled) {
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                } else {
                    field.setAttribute('readonly', 'readonly');
                }
            }
        });
    }
    
    /**
     * Renderiza los botones del footer según el modo
     */
    function renderButtons(mode) {
        footer.innerHTML = '';
        
        if (mode === 'view') {
            footer.innerHTML = `
                <button type="button" class="btn btn-danger" onclick="SparePartModal.confirmDelete()">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
                <button type="button" class="btn btn-primary" onclick="SparePartModal.switchToEditMode()">
                    <i class="bi bi-pencil"></i> Editar
                </button>
            `;
        } else if (mode === 'edit') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="SparePartModal.cancelEdit()">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-success" id="sparePartSubmitBtn">
                    <i class="bi bi-check-lg"></i> Guardar Cambios
                </button>
            `;
        } else if (mode === 'create') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-success" id="sparePartSubmitBtn">
                    <i class="bi bi-check-lg"></i> Guardar Repuesto
                </button>
            `;
        }
    }
    
    /**
     * Maneja el envío del formulario
     */
    function handleSubmit(e) {
            e.preventDefault();
            
        const submitBtn = document.getElementById('sparePartSubmitBtn');
        if (!submitBtn) return;
        
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
        const formData = new FormData(form);
            
        fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    if (data.success) {
                    SIGVENotifications.success(data.message || 'Repuesto guardado correctamente');
                        modalInstance.hide();
                    setTimeout(() => window.location.reload(), 1500);
                    } else if (data.errors) {
                        SIGVENotifications.showValidationErrors(data.errors);
                        submitBtn.disabled = false;
                    submitBtn.innerHTML = currentMode === 'create' 
                        ? '<i class="bi bi-check-lg"></i> Guardar Repuesto'
                        : '<i class="bi bi-check-lg"></i> Guardar Cambios';
                }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            SIGVENotifications.error('Error al guardar el repuesto');
                submitBtn.disabled = false;
            submitBtn.innerHTML = currentMode === 'create'
                ? '<i class="bi bi-check-lg"></i> Guardar Repuesto'
                : '<i class="bi bi-check-lg"></i> Guardar Cambios';
        });
    }
    
    /**
     * Confirma la eliminación del repuesto
     */
    function confirmDelete() {
        if (!currentSparePartId) return;
        
        if (confirm('¿Estás seguro de eliminar este repuesto? Esta acción no se puede deshacer.')) {
            const deleteForm = document.createElement('form');
            deleteForm.method = 'POST';
            deleteForm.action = `/sigve/spare-parts/${currentSparePartId}/delete/`;
            deleteForm.innerHTML = '<input type="hidden" name="csrfmiddlewaretoken" value="' + 
                                   document.querySelector('[name=csrfmiddlewaretoken]').value + '">';
            document.body.appendChild(deleteForm);
            deleteForm.submit();
        }
    }
    
    function showLoading() {
        loading.style.display = 'block';
        form.style.display = 'none';
    }
    
    function hideLoading() {
        loading.style.display = 'none';
    }
    
    function showForm() {
        form.style.display = 'block';
    }
    
    function resetModal() {
        currentMode = 'create';
        currentSparePartId = null;
        form.reset();
        setFieldsEnabled(true);
        footer.innerHTML = '';
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    return {
        open,
        switchToEditMode,
        cancelEdit,
        confirmDelete
    };
})();
</script>
