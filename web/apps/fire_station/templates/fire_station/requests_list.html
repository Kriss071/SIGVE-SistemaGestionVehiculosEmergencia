{% extends 'fire_station/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/fire_station/requests_list.css' %}">
<style>
.table tbody tr {
    cursor: pointer;
    transition: background-color 0.2s;
}

.table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.badge {
    font-size: 0.85rem;
    padding: 0.35em 0.65em;
}

.card {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-wrench-adjustable-circle"></i> Solicitudes de Mantenimiento</h1>
            <button type="button" class="btn btn-warning" onclick="RequestModal.open('create')">
                <i class="bi bi-plus-circle"></i> Nueva Solicitud
            </button>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <label for="statusFilter" class="form-label">Estado</label>
                <select class="form-select" name="status_id" id="statusFilter" onchange="this.form.submit()">
                    <option value="">Todos los estados</option>
                    {% for status in request_statuses %}
                        <option value="{{ status.id }}" {% if filters.status_id == status.id|stringformat:"s" %}selected{% endif %}>
                            {{ status.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="vehicleFilter" class="form-label">Vehículo</label>
                <select class="form-select" name="vehicle_id" id="vehicleFilter" onchange="this.form.submit()">
                    <option value="">Todos los vehículos</option>
                    {% for vehicle in vehicles %}
                        <option value="{{ vehicle.id }}" {% if filters.vehicle_id == vehicle.id|stringformat:"s" %}selected{% endif %}>
                            {{ vehicle.license_plate }} - {{ vehicle.brand }} {{ vehicle.model }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12">
                <a href="{% url 'fire_station:requests_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Solicitudes -->
<div class="card">
    <div class="card-body">
        {% if requests %}
        
        <div class="mb-3">
            <input type="text" id="tableSearchInput" class="form-control" placeholder="Buscar en la tabla...">
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="requestsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Vehículo</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Solicitante</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr onclick="window.location.href='{% url 'fire_station:request_detail' req.id %}'">
                        <td><strong>#{{ req.id }}</strong></td>
                        <td>{{ req.created_at|date:"d/m/Y H:i" }}</td>
                        <td>
                            <strong>{{ req.vehicle.license_plate }}</strong><br>
                            <small class="text-muted">{{ req.vehicle.brand }} {{ req.vehicle.model }}</small>
                        </td>
                        <td>{{ req.request_type.name|default:"—" }}</td>
                        <td>
                            <span class="badge 
                                {% if req.request_status.name == 'Pendiente' %}bg-secondary
                                {% elif req.request_status.name == 'En Revisión' %}bg-info
                                {% elif req.request_status.name == 'Aprobada' %}bg-success
                                {% elif req.request_status.name == 'Rechazada' %}bg-danger
                                {% elif req.request_status.name == 'Cancelada' %}bg-warning
                                {% else %}bg-dark
                                {% endif %}">
                                {{ req.request_status.name }}
                            </span>
                        </td>
                        <td>
                            {% if req.requested_by %}
                                {{ req.requested_by.first_name }} {{ req.requested_by.last_name }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if req.request_status.name == 'Pendiente' or req.request_status.name == 'En Revisión' %}
                            <button type="button" class="btn btn-sm btn-outline-warning" 
                                    onclick="event.stopPropagation(); ConfirmationModal.open({
                                        formAction: '{% url 'fire_station:request_cancel' req.id %}',
                                        warningText: '¿Estás seguro de cancelar la solicitud #{{ req.id }}?',
                                        title: 'Confirmar Cancelación',
                                        btnClass: 'btn-warning',
                                        btnText: 'Sí, Cancelar'
                                    })">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="event.stopPropagation(); window.location.href='{% url 'fire_station:request_detail' req.id %}'">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-wrench-adjustable-circle display-1 text-muted"></i>
            <p class="text-muted mt-3">No hay solicitudes registradas</p>
            <button type="button" class="btn btn-warning" onclick="RequestModal.open('create')">
                <i class="bi bi-plus-circle"></i> Crear Primera Solicitud
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Incluir los modales -->
{% include 'fire_station/modals/request_modal.html' %}
{% include 'fire_station/modals/confirmation_modal.html' %}

<!-- Form oculto para cancelar -->
<form id="confirmationForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/modal.js' %}"></script>
<script>
/**
 * Fire Station - Requests List JavaScript
 */
(function() {
    'use strict';

    window.RequestModal = (function() {
        const modal = document.getElementById('requestModal');
        const form = document.getElementById('requestForm');
        let modalInstance = null;
        
        function init() {
            if (!modal || !form) return;
            modalInstance = new bootstrap.Modal(modal);
            modal.addEventListener('hidden.bs.modal', resetModal);
            form.addEventListener('submit', handleSubmit);
        }
        
        function open(mode = 'create') {
            if (mode === 'create') {
                form.reset();
                modalInstance.show();
            }
        }
        
        function handleSubmit(e) {
            e.preventDefault();
            
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            const submitBtn = document.getElementById('requestSubmitBtn');
            if (!submitBtn) return;
            
            if (window.SIGVE && window.SIGVE.showButtonLoading) {
                window.SIGVE.showButtonLoading(submitBtn);
            }
            
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.redirected ? window.location.href = response.url : response.json())
            .then(data => {
                if (data && data.success) {
                    if (window.SIGVE && window.SIGVE.hideButtonLoading) {
                        window.SIGVE.hideButtonLoading(submitBtn);
                    }
                    modalInstance.hide();
                    setTimeout(() => window.location.reload(), 150);
                } else if (data && data.errors) {
                    const firstError = Object.values(data.errors)[0][0];
                    if (window.SIGVE && window.SIGVE.showNotification) {
                        window.SIGVE.showNotification(firstError, 'error');
                    }
                    if (window.SIGVE && window.SIGVE.hideButtonLoading) {
                        window.SIGVE.hideButtonLoading(submitBtn);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (window.SIGVE && window.SIGVE.showNotification) {
                    window.SIGVE.showNotification('Error al crear la solicitud', 'error');
                }
                if (window.SIGVE && window.SIGVE.hideButtonLoading) {
                    window.SIGVE.hideButtonLoading(submitBtn);
                }
            });
        }
        
        function resetModal() {
            form.reset();
            form.classList.remove('was-validated');
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        return { open };
    })();

    document.addEventListener('DOMContentLoaded', function() {
        if (window.SIGVE && window.SIGVE.setupTableSearch) {
            window.SIGVE.setupTableSearch('tableSearchInput', 'requestsTable');
        }
    });
})();
</script>
{% endblock %}

