{% extends 'workshop/base.html' %}
{% load static %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="bi bi-plus-circle"></i> Nueva Orden de Mantención</h1>
    </div>
</div>

{% if step == 'search_vehicle' %}
<!-- Paso 1: Buscar Vehículo -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Paso 1: Buscar Vehículo</h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="search_vehicle">
            <div class="mb-3">
                <label class="form-label">Patente del Vehículo</label>
                <input type="text" name="license_plate" class="form-control form-control-lg" 
                       placeholder="Ej: ABCD12" style="text-transform:uppercase;" required autofocus>
                <small class="text-muted">Si el vehículo no está registrado, podrás crearlo a continuación.</small>
            </div>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-search"></i> Buscar Vehículo
            </button>
        </form>
    </div>
</div>

{% elif step == 'create_vehicle' %}
<!-- Paso 2: Crear Vehículo Nuevo -->
<div class="card">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">Paso 2: Registrar Vehículo Nuevo</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> El vehículo con patente <strong>{{ license_plate }}</strong> no está registrado. Por favor completa los siguientes datos.
        </div>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_vehicle">
            <input type="hidden" name="license_plate" value="{{ license_plate }}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Marca</label>
                    <input type="text" name="brand" class="form-control" placeholder="Ej: Mercedes-Benz" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Modelo</label>
                    <input type="text" name="model" class="form-control" placeholder="Ej: Atego 1725" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Año</label>
                    <input type="number" name="year" class="form-control" min="1900" max="2100" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tipo de Vehículo</label>
                    <select name="vehicle_type_id" class="form-select" required>
                        <option value="">Selecciona...</option>
                        {% for vtype in catalog_data.vehicle_types %}
                        <option value="{{ vtype.id }}">{{ vtype.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cuartel</label>
                    <select name="fire_station_id" class="form-select" required>
                        <option value="">Selecciona...</option>
                        {% for station in fire_stations %}
                        <option value="{{ station.id }}">{{ station.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Número de Motor</label>
                    <input type="text" name="engine_number" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">VIN / Chasis</label>
                    <input type="text" name="vin" class="form-control">
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-save"></i> Registrar y Continuar
                </button>
            </div>
        </form>
    </div>
</div>

{% elif step == 'create_order' %}
<!-- Paso 3: Crear Orden -->
<div class="card mb-3">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Vehículo Encontrado</h5>
    </div>
    <div class="card-body">
        <p><strong>Patente:</strong> <span class="badge bg-dark">{{ vehicle.license_plate }}</span></p>
        <p><strong>Vehículo:</strong> {{ vehicle.brand }} {{ vehicle.model }} ({{ vehicle.year }})</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Paso 3: Datos de la Orden de Mantención</h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_order">
            <input type="hidden" name="vehicle_id" value="{{ vehicle.id }}">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Kilometraje de Ingreso</label>
                    <input type="number" name="mileage" class="form-control" min="0" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tipo de Mantención</label>
                    <select name="maintenance_type_id" class="form-select" required>
                        <option value="">Selecciona...</option>
                        {% for mtype in maintenance_types %}
                        <option value="{{ mtype.id }}">{{ mtype.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Estado de la Orden</label>
                    <select name="order_status_id" class="form-select" required>
                        {% for status in order_statuses %}
                        <option value="{{ status.id }}" {% if status.name == 'En Taller' %}selected{% endif %}>
                            {{ status.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Mecánico Asignado</label>
                    <select name="assigned_mechanic_id" class="form-select">
                        <option value="">Sin asignar</option>
                        {% for mechanic in mechanics %}
                        <option value="{{ mechanic.id }}">{{ mechanic.first_name }} {{ mechanic.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Fecha de Ingreso</label>
                    <input type="date" name="entry_date" class="form-control" value="{% now 'Y-m-d' %}">
                </div>
                <div class="col-md-12">
                    <label class="form-label">Observaciones</label>
                    <textarea name="observations" class="form-control" rows="3" 
                              placeholder="Notas generales sobre la orden..."></textarea>
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-check-circle"></i> Crear Orden
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}




